'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.seeder = undefined;

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _csvParse = require('csv-parse');

var _csvParse2 = _interopRequireDefault(_csvParse);

var _iconvLite = require('iconv-lite');

var _iconvLite2 = _interopRequireDefault(_iconvLite);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _events = require('events');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const seeder = exports.seeder = {
  seed(options) {
    return knex => {
      return new Promise((resolve, reject) => {
        KnexSeeder.fromKnexClient(knex).on('end', resolve).on('error', reject).generate(options);
      });
    };
  }
};

exports.default = seeder.seed;


class KnexSeeder extends _events.EventEmitter {

  constructor(knex) {
    super();
    this.opts = {};
    this.knex = knex;
    this.headers = [];
    this.records = [];
    this.parser = null;
    this.queue = null;
    this.results = [];
    this.onReadable = this.onReadable.bind(this);
    this.onEnd = this.onEnd.bind(this);
    this.onSucceeded = this.onSucceeded.bind(this);
    this.onFailed = this.onFailed.bind(this);
  }

  static fromKnexClient(knex) {
    return new KnexSeeder(knex);
  }

  mergeOptions(options) {
    let opts = options || {};
    let defaults = {
      file: null,
      table: null,
      encoding: 'utf8',
      recordsPerQuery: 100,
      parser: {
        delimiter: ',',
        quote: '"',
        escape: '\\',
        skip_empty_lines: true,
        auto_parse: true
      }
    };

    return _lodash2.default.merge({}, defaults, opts);
  }

  generate(options) {
    this.opts = this.mergeOptions(options);

    this.parser = (0, _csvParse2.default)(this.opts.parser);
    this.parser.on('readable', this.onReadable);
    this.parser.on('end', this.onEnd);
    this.parser.on('error', this.onFailed);

    this.queue = Promise.bind(this).then(this.createCleanUpQueue());

    this.csv = _fs2.default.createReadStream(this.opts.file);
    this.csv.pipe(_iconvLite2.default.decodeStream(this.opts.encoding)).pipe(this.parser);
  }

  onReadable() {
    let obj = {};
    let record = this.parser.read();

    if (record === null) {
      return;
    }

    if (this.parser.count <= 1) {
      this.headers = record;
    } else {
      this.records.push(this.createObjectFrom(record));
    }

    if (this.records.length < this.opts.recordsPerQuery) {
      return;
    }

    this.queue = this.queue.then(this.createBulkInsertQueue());
  }
  onEnd() {
    if (this.records.length > 0) {
      this.queue = this.queue.then(this.createBulkInsertQueue());
    }
    this.queue.then(() => {
      return this.emit('end', this.results);
    }).catch(this.onFailed);
  }
  createCleanUpQueue() {
    return () => {
      return this.knex(this.opts.table).del().then(this.onSucceeded).catch(this.onFailed);
    };
  }
  createBulkInsertQueue() {
    const records = this.records.splice(0, this.opts.recordsPerQuery);

    return () => {
      return this.knex(this.opts.table).insert(records).then(this.onSucceeded).catch(this.onFailed);
    };
  }
  createObjectFrom(record) {
    let obj = {};

    this.headers.forEach((column, i) => {
      let val = record[i];

      if (typeof val === 'string' && val.toLowerCase() === 'null') {
        val = null;
      }
      obj[column] = val;
    });
    return obj;
  }
  onSucceeded(res) {
    this.results.push(res);
  }
  onFailed(err) {
    this.csv.unpipe();
    this.emit('error', err);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZWVkZXIuanMiXSwibmFtZXMiOlsic2VlZGVyIiwic2VlZCIsIm9wdGlvbnMiLCJrbmV4IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJLbmV4U2VlZGVyIiwiZnJvbUtuZXhDbGllbnQiLCJvbiIsImdlbmVyYXRlIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJvcHRzIiwiaGVhZGVycyIsInJlY29yZHMiLCJwYXJzZXIiLCJxdWV1ZSIsInJlc3VsdHMiLCJvblJlYWRhYmxlIiwiYmluZCIsIm9uRW5kIiwib25TdWNjZWVkZWQiLCJvbkZhaWxlZCIsIm1lcmdlT3B0aW9ucyIsImRlZmF1bHRzIiwiZmlsZSIsInRhYmxlIiwiZW5jb2RpbmciLCJyZWNvcmRzUGVyUXVlcnkiLCJkZWxpbWl0ZXIiLCJxdW90ZSIsImVzY2FwZSIsInNraXBfZW1wdHlfbGluZXMiLCJhdXRvX3BhcnNlIiwiXyIsIm1lcmdlIiwidGhlbiIsImNyZWF0ZUNsZWFuVXBRdWV1ZSIsImNzdiIsImZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsInBpcGUiLCJpY29udiIsImRlY29kZVN0cmVhbSIsIm9iaiIsInJlY29yZCIsInJlYWQiLCJjb3VudCIsInB1c2giLCJjcmVhdGVPYmplY3RGcm9tIiwibGVuZ3RoIiwiY3JlYXRlQnVsa0luc2VydFF1ZXVlIiwiZW1pdCIsImNhdGNoIiwiZGVsIiwic3BsaWNlIiwiaW5zZXJ0IiwiZm9yRWFjaCIsImNvbHVtbiIsImkiLCJ2YWwiLCJ0b0xvd2VyQ2FzZSIsInJlcyIsImVyciIsInVucGlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFTyxNQUFNQSwwQkFBUztBQUNwQkMsT0FBS0MsT0FBTCxFQUFjO0FBQ1osV0FBUUMsSUFBRCxJQUFVO0FBQ2YsYUFBTyxJQUFJQyxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RD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QUwsQ0FBVWMsS0FBcEIsRUFDSjhCLE1BREksQ0FDRzFDLE9BREgsRUFFSnNCLElBRkksQ0FFQyxLQUFLZixXQUZOLEVBR0pnQyxLQUhJLENBR0UsS0FBSy9CLFFBSFAsQ0FBUDtBQUlELEtBTEQ7QUFNRDtBQUNEMkIsbUJBQWlCSixNQUFqQixFQUF5QjtBQUN2QixRQUFJRCxNQUFNLEVBQVY7O0FBRUEsU0FBSy9CLE9BQUwsQ0FBYTRDLE9BQWIsQ0FBcUIsQ0FBQ0MsTUFBRCxFQUFTQyxDQUFULEtBQWU7QUFDbEMsVUFBSUMsTUFBTWYsT0FBT2MsQ0FBUCxDQUFWOztBQUVBLFVBQUksT0FBT0MsR0FBUCxLQUFlLFFBQWYsSUFBMkJBLElBQUlDLFdBQUosT0FBc0IsTUFBckQsRUFBNkQ7QUFDM0RELGNBQU0sSUFBTjtBQUNEO0FBQ0RoQixVQUFJYyxNQUFKLElBQWNFLEdBQWQ7QUFDRCxLQVBEO0FBUUEsV0FBT2hCLEdBQVA7QUFDRDtBQUNEdkIsY0FBWXlDLEdBQVosRUFBaUI7QUFDZixTQUFLN0MsT0FBTCxDQUFhK0IsSUFBYixDQUFrQmMsR0FBbEI7QUFDRDtBQUNEeEMsV0FBU3lDLEdBQVQsRUFBYztBQUNaLFNBQUt6QixHQUFMLENBQVMwQixNQUFUO0FBQ0EsU0FBS1osSUFBTCxDQUFVLE9BQVYsRUFBbUJXLEdBQW5CO0FBQ0Q7QUF0SG1DIiwiZmlsZSI6InNlZWRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGFyc2UgZnJvbSAnY3N2LXBhcnNlJztcbmltcG9ydCBpY29udiBmcm9tICdpY29udi1saXRlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuXG5leHBvcnQgY29uc3Qgc2VlZGVyID0ge1xuICBzZWVkKG9wdGlvbnMpIHtcbiAgICByZXR1cm4gKGtuZXgpID0+IHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIEtuZXhTZWVkZXIuZnJvbUtuZXhDbGllbnQoa25leClcbiAgICAgICAgICAub24oJ2VuZCcsIHJlc29sdmUpXG4gICAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdClcbiAgICAgICAgICAuZ2VuZXJhdGUob3B0aW9ucyk7XG4gICAgICB9KTtcbiAgICB9O1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBzZWVkZXIuc2VlZDtcblxuY2xhc3MgS25leFNlZWRlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG5cbiAgY29uc3RydWN0b3Ioa25leCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5vcHRzID0ge307XG4gICAgdGhpcy5rbmV4ID0ga25leDtcbiAgICB0aGlzLmhlYWRlcnMgPSBbXTtcbiAgICB0aGlzLnJlY29yZHMgPSBbXTtcbiAgICB0aGlzLnBhcnNlciA9IG51bGw7XG4gICAgdGhpcy5xdWV1ZSA9IG51bGw7XG4gICAgdGhpcy5yZXN1bHRzID0gW107XG4gICAgdGhpcy5vblJlYWRhYmxlID0gdGhpcy5vblJlYWRhYmxlLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vbkVuZCA9IHRoaXMub25FbmQuYmluZCh0aGlzKTtcbiAgICB0aGlzLm9uU3VjY2VlZGVkID0gdGhpcy5vblN1Y2NlZWRlZC5iaW5kKHRoaXMpO1xuICAgIHRoaXMub25GYWlsZWQgPSB0aGlzLm9uRmFpbGVkLmJpbmQodGhpcyk7XG4gIH1cblxuICBzdGF0aWMgZnJvbUtuZXhDbGllbnQoa25leCkge1xuICAgIHJldHVybiBuZXcgS25leFNlZWRlcihrbmV4KTtcbiAgfVxuXG4gIG1lcmdlT3B0aW9ucyhvcHRpb25zKSB7XG4gICAgbGV0IG9wdHMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGxldCBkZWZhdWx0cyA9IHtcbiAgICAgIGZpbGU6IG51bGwsXG4gICAgICB0YWJsZTogbnVsbCxcbiAgICAgIGVuY29kaW5nOiAndXRmOCcsXG4gICAgICByZWNvcmRzUGVyUXVlcnk6IDEwMCxcbiAgICAgIHBhcnNlcjoge1xuICAgICAgICBkZWxpbWl0ZXI6ICcsJyxcbiAgICAgICAgcXVvdGU6ICdcIicsXG4gICAgICAgIGVzY2FwZTogJ1xcXFwnLFxuICAgICAgICBza2lwX2VtcHR5X2xpbmVzOiB0cnVlLFxuICAgICAgICBhdXRvX3BhcnNlOiB0cnVlXG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBfLm1lcmdlKHt9LCBkZWZhdWx0cywgb3B0cyk7XG4gIH1cblxuICBnZW5lcmF0ZShvcHRpb25zKSB7XG4gICAgdGhpcy5vcHRzID0gdGhpcy5tZXJnZU9wdGlvbnMob3B0aW9ucyk7XG5cbiAgICB0aGlzLnBhcnNlciA9IHBhcnNlKHRoaXMub3B0cy5wYXJzZXIpO1xuICAgIHRoaXMucGFyc2VyLm9uKCdyZWFkYWJsZScsIHRoaXMub25SZWFkYWJsZSk7XG4gICAgdGhpcy5wYXJzZXIub24oJ2VuZCcsIHRoaXMub25FbmQpO1xuICAgIHRoaXMucGFyc2VyLm9uKCdlcnJvcicsIHRoaXMub25GYWlsZWQpO1xuXG4gICAgdGhpcy5xdWV1ZSA9IFByb21pc2UuYmluZCh0aGlzKS50aGVuKCB0aGlzLmNyZWF0ZUNsZWFuVXBRdWV1ZSgpICk7XG5cbiAgICB0aGlzLmNzdiA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0odGhpcy5vcHRzLmZpbGUpO1xuICAgIHRoaXMuY3N2LnBpcGUoIGljb252LmRlY29kZVN0cmVhbSh0aGlzLm9wdHMuZW5jb2RpbmcpICkucGlwZSh0aGlzLnBhcnNlcik7XG4gIH1cblxuICBvblJlYWRhYmxlKCkge1xuICAgIGxldCBvYmogPSB7fTtcbiAgICBsZXQgcmVjb3JkID0gdGhpcy5wYXJzZXIucmVhZCgpO1xuXG4gICAgaWYgKHJlY29yZCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcnNlci5jb3VudCA8PSAxKSB7XG4gICAgICB0aGlzLmhlYWRlcnMgPSByZWNvcmQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVjb3Jkcy5wdXNoKCB0aGlzLmNyZWF0ZU9iamVjdEZyb20ocmVjb3JkKSApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlY29yZHMubGVuZ3RoIDwgdGhpcy5vcHRzLnJlY29yZHNQZXJRdWVyeSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucXVldWUgPSB0aGlzLnF1ZXVlLnRoZW4oIHRoaXMuY3JlYXRlQnVsa0luc2VydFF1ZXVlKCkgKTtcbiAgfVxuICBvbkVuZCgpIHtcbiAgICBpZiAodGhpcy5yZWNvcmRzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMucXVldWUgPSB0aGlzLnF1ZXVlLnRoZW4oIHRoaXMuY3JlYXRlQnVsa0luc2VydFF1ZXVlKCkgKTtcbiAgICB9XG4gICAgdGhpcy5xdWV1ZS50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmVtaXQoJ2VuZCcsIHRoaXMucmVzdWx0cyk7XG4gICAgfSkuY2F0Y2godGhpcy5vbkZhaWxlZCk7XG4gIH1cbiAgY3JlYXRlQ2xlYW5VcFF1ZXVlKCkge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5rbmV4KHRoaXMub3B0cy50YWJsZSkuZGVsKClcbiAgICAgICAgLnRoZW4odGhpcy5vblN1Y2NlZWRlZClcbiAgICAgICAgLmNhdGNoKHRoaXMub25GYWlsZWQpO1xuICAgIH07XG4gIH1cbiAgY3JlYXRlQnVsa0luc2VydFF1ZXVlKCkge1xuICAgIGNvbnN0IHJlY29yZHMgPSB0aGlzLnJlY29yZHMuc3BsaWNlKDAsIHRoaXMub3B0cy5yZWNvcmRzUGVyUXVlcnkpO1xuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmtuZXgodGhpcy5vcHRzLnRhYmxlKVxuICAgICAgICAuaW5zZXJ0KHJlY29yZHMpXG4gICAgICAgIC50aGVuKHRoaXMub25TdWNjZWVkZWQpXG4gICAgICAgIC5jYXRjaCh0aGlzLm9uRmFpbGVkKTtcbiAgICB9O1xuICB9XG4gIGNyZWF0ZU9iamVjdEZyb20ocmVjb3JkKSB7XG4gICAgbGV0IG9iaiA9IHt9O1xuXG4gICAgdGhpcy5oZWFkZXJzLmZvckVhY2goKGNvbHVtbiwgaSkgPT4ge1xuICAgICAgbGV0IHZhbCA9IHJlY29yZFtpXTtcblxuICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnICYmIHZhbC50b0xvd2VyQ2FzZSgpID09PSAnbnVsbCcpIHtcbiAgICAgICAgdmFsID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIG9ialtjb2x1bW5dID0gdmFsO1xuICAgIH0pO1xuICAgIHJldHVybiBvYmo7XG4gIH1cbiAgb25TdWNjZWVkZWQocmVzKSB7XG4gICAgdGhpcy5yZXN1bHRzLnB1c2gocmVzKTtcbiAgfVxuICBvbkZhaWxlZChlcnIpIHtcbiAgICB0aGlzLmNzdi51bnBpcGUoKTtcbiAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKTtcbiAgfVxufVxuIl19